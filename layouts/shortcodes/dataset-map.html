<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dataset Map</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

  <style>
    #dataset-map {
      height: 600px;
      margin-bottom: 2em;
    }
    /* Prevent global img rules from shrinking Leaflet tiles */
    .leaflet-container img { max-width: none !important; }

    .popup-thumb {
      width: 120px;
      height: auto;
      display: block;
      margin-bottom: 0.5em;
      border-radius: 6px;
    }
    .popup-links a {
      display: block;         /* each on its own line */
      text-decoration: underline;
      margin: 0.15em 0;
    }
  </style>
</head>
<body>

  <div id="dataset-map" role="region" aria-label="Archaeological sites map"></div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <script>
    (function () {
      // Create the map; prefer Canvas to avoid DOM/icon drift
      var map = L.map('dataset-map', {
        zoomControl: true,
        worldCopyJump: true,
        preferCanvas: true
      });

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors',
        detectRetina: true,
        maxZoom: 19
      }).addTo(map);

      // Build popup HTML (links on separate lines)
      function buildPopup(site) {
        var html = '';
        if (site.thumbnail) {
          html += '<img class="popup-thumb" src="' + site.thumbnail + '" alt="Thumbnail for ' + (site.name || 'site') + '">';
        }
        if (site.name) {
          html += '<strong>' + site.name + '</strong><br>';
        }
        html += '<div class="popup-links">';
        if (site.attribute_url) {
          html += '<a href="' + site.attribute_url + '" target="_blank" rel="noopener">Attribute data</a>';
        }
        if (site["3d_url"]) {
          html += '<a href="' + site["3d_url"] + '" target="_blank" rel="noopener">3D data</a>';
        }
        html += '</div>';
        return html;
      }

      // Style for circle markers (Canvas)
      var circleStyle = {
        radius: 6,
        weight: 2,
        color: '#1f6feb',   // outline (Leaflet will pick default if this is removed)
        fillColor: '#1f6feb',
        fillOpacity: 0.7
      };

      fetch('/data/datasets.json', { cache: 'no-cache' })
        .then(function (r) {
          if (!r.ok) throw new Error('HTTP ' + r.status);
          return r.json();
        })
        .then(function (data) {
          if (!Array.isArray(data)) {
            console.error('datasets.json is not an array');
            map.setView([42.5, 12.5], 5);
            return;
          }

          var latlngs = [];

          data.forEach(function (site, idx) {
            var lat = Number(site.lat);
            var lon = Number(site.lon);
            var validLat = Number.isFinite(lat) && lat >= -90 && lat <= 90;
            var validLon = Number.isFinite(lon) && lon >= -180 && lon <= 180;
            if (!validLat || !validLon) {
              console.warn('Skipping site with invalid coords at index', idx, site);
              return;
            }

            // Use vector marker (Canvas) â€” immune to DOM/CSS drift
            var cm = L.circleMarker([lat, lon], circleStyle)
              .addTo(map)
              .bindPopup(buildPopup(site));

            latlngs.push([lat, lon]);
          });

          if (latlngs.length) {
            map.fitBounds(L.latLngBounds(latlngs).pad(0.2));
          } else {
            map.setView([42.5, 12.5], 5);
          }
        })
        .catch(function (err) {
          console.error('Error loading datasets.json:', err);
          map.setView([42.5, 12.5], 5);
        });

      // If the map is inside a hidden tab or layout that changes size, this keeps tiles aligned
      window.addEventListener('resize', function () {
        map.invalidateSize({ debounceMoveend: true });
      });

      // --- If/when you want the classic pin icons back ---
      // 1) Remove preferCanvas:true above
      // 2) Replace L.circleMarker(...) with:
      /*
      var marker = L.marker([lat, lon]).addTo(map).bindPopup(buildPopup(site));
      */
      // 3) Ensure NO ancestor of #dataset-map has transform/scale/filter/perspective/zoom.
      //    Those create new containing blocks and cause DOM icon drift at low zooms.
    })();
  </script>
</body>
</html>