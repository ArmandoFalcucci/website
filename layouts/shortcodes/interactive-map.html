<div style="position: relative; display: inline-block;">
  
  <img src="/media/map-dataset.png" width="3311" height="2064" alt="Map of archaeological sites" style="max-width: 100%; height: auto;">

  <div class="site-pin"
       style="position: absolute; left: 35.76%; top: 35.56%; transform: translate(-50%, -100%); cursor: pointer; z-index:10;">
       <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="red" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
  </div>

  <div class="site-pin"
       style="position: absolute; left: 30.44%; top: 42.25%; transform: translate(-50%, -100%); cursor: pointer; z-index:10;">
       <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="red" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
  </div>

  <div class="site-pin"
       style="position: absolute; left: 43.19%; top: 54.02%; transform: translate(-50%, -100%); cursor: pointer; z-index:10;">
       <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="red" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
  </div>

  <div class="site-pin"
       style="position: absolute; left: 42.89%; top: 55.52%; transform: translate(-50%, -100%); cursor: pointer; z-index:10;">
       <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="red" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
  </div>

  <div class="site-pin"
       style="position: absolute; left: 76.26%; top: 70.64%; transform: translate(-50%, -100%); cursor: pointer; z-index:10;">
       <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="red" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
  </div>
</div>

<div id="popup" style="position: fixed; display: none; background: white; border: 1px solid #ccc; padding: 15px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); z-index: 1000; text-align: center; max-width: 200px;">
</div>

<script>
  if (!window.interactiveMapInitialized) {
    const popup = document.getElementById('popup');
    const pins = document.querySelectorAll('.site-pin');

    pins.forEach(pin => {
      pin.addEventListener('click', function(event) {
        event.stopPropagation();
        
        let htmlContent = '';
        if (this.dataset.thumbnail) {
          htmlContent += `<img src="${this.dataset.thumbnail}" alt="${this.dataset.name}" style="width: 100%; height: auto; display: block; margin-bottom: 10px; border-radius: 4px;">`;
        }
        htmlContent += `<strong style="font-size: 1.1em; color: black;">${this.dataset.name}</strong><br>`;
        
        let links = [];
        if (this.dataset.attribute) {
          links.push(`<a href="${this.dataset.attribute}" target="_blank" rel="noopener noreferrer" style="color: #007bff; text-decoration: none;">Attribute data</a>`);
        }
        if (this.dataset['3d']) {
          links.push(`<a href="${this.dataset['3d']}" target="_blank" rel="noopener noreferrer" style="color: #007bff; text-decoration: none;">3D data</a>`);
        }
        
        if (links.length > 0) {
          // The separator is now wrapped in a span with a specific color to ensure visibility
          htmlContent += `<div style="margin-top: 10px;">${links.join(' <span style="color: #6c757d;">|</span> ')}</div>`;
        }
        
        popup.innerHTML = htmlContent;

        const pinRect = this.getBoundingClientRect();
        popup.style.display = 'block'; 
        
        const popupRect = popup.getBoundingClientRect();
        let topPos = pinRect.top + window.scrollY - popupRect.height - 10; 
        let leftPos = pinRect.left + window.scrollX + (pinRect.width / 2) - (popupRect.width / 2);

        if (topPos < window.scrollY) {
            topPos = pinRect.bottom + window.scrollY + 10;
        }
        if (leftPos < window.scrollX) {
            leftPos = window.scrollX + 5;
        }
        if (leftPos + popupRect.width > window.innerWidth) {
            leftPos = window.innerWidth - popupRect.width - 5;
        }

        popup.style.top = `${topPos}px`;
        popup.style.left = `${leftPos}px`;
        popup.style.position = 'absolute'; 
      });
    });

    document.addEventListener('click', function(event) {
      if (popup.style.display === 'block' && !popup.contains(event.target) && !event.target.classList.contains('site-pin')) {
        popup.style.display = 'none';
      }
    });

    window.interactiveMapInitialized = true;
  }
</script>